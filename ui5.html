<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†åŠ›å¥åº·åŠ©æ‰‹ Â· çœ¼ç§‘å¤šæ¨¡æ€AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        body { background: #f6f7fb; }
        .card-shadow { box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
        .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); }
        .tab-active { color: #2563eb !important; border-bottom: 2px solid #2563eb; }
        .bubble { animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from {opacity:0;transform:translateY(6px);} to {opacity:1;transform:translateY(0);} }
        .chip { padding: 6px 12px; border-radius: 999px; font-size: 12px; cursor: pointer; transition: all .2s; }
        .chip:hover { transform: translateY(-1px); }
        .gradient-blue { background: linear-gradient(135deg,#3498DB,#2980B9); }
        .gradient-green { background: linear-gradient(135deg,#2ECC71,#27AE60); }
        .gradient-purple { background: linear-gradient(135deg,#9B59B6,#8E44AD); }
    </style>
</head>
<body class="font-sans text-slate-800">
    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="glass card-shadow rounded-2xl p-4 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-2xl gradient-blue text-white flex items-center justify-center text-xl font-semibold">
                    ğŸ‘ï¸
                </div>
                <div>
                    <div class="text-lg font-semibold">è§†åŠ›å¥åº·åŠ©æ‰‹ Â· çœ¼ç§‘å¤šæ¨¡æ€AI</div>
                    <div class="text-sm text-slate-500" id="statusSub">æ™ºèƒ½å¯¹è¯ / è§†åŠ›æ£€æµ‹ / OCTå½±åƒ / é£é™©è¯„ä¼°</div>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span class="w-3 h-3 rounded-full bg-emerald-500" id="statusDot"></span>
                <span id="statusText">æœåŠ¡æ­£å¸¸</span>
            </div>
        </div>

        <!-- ä¸»ä½“å¸ƒå±€ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- å·¦ä¾§ï¼šæ¨¡å—åˆ‡æ¢ + å†…å®¹ -->
            <div class="lg:col-span-2">
                <div class="glass card-shadow rounded-2xl overflow-hidden">
                    <!-- Tabs -->
                    <div class="grid grid-cols-4 text-center text-sm border-b border-slate-100">
                        <button class="py-3 tab-active" data-tab="tab-vision" onclick="switchTab('tab-vision')">æµ‹è§†åŠ›</button>
                        <button class="py-3" data-tab="tab-chat" onclick="switchTab('tab-chat')">AIåŒ»ç”Ÿ</button>
                        <button class="py-3" data-tab="tab-disease" onclick="switchTab('tab-disease')">ç–¾ç—…è¯Šæ–­</button>
                        <button class="py-3" data-tab="tab-profile" onclick="switchTab('tab-profile')">ä¸ªäººä¸­å¿ƒ</button>
                    </div>

                    <!-- Tab: è§†åŠ›æ£€æµ‹ -->
                    <div id="tab-vision" class="p-4 md:p-6 space-y-4 tab-panel">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 glass rounded-xl p-4 border border-slate-100">
                                <div class="flex items-center justify-between mb-2">
                                    <div>
                                        <div class="text-sm text-slate-500">ä¸Šæ¬¡æ£€æµ‹</div>
                                        <div class="text-lg font-semibold" id="visionSummary">--</div>
                                    </div>
                                    <button class="gradient-blue text-white px-4 py-2 rounded-lg text-sm shadow" onclick="startVisionTest()">
                                        <i class="fa fa-play mr-1"></i> å¼€å§‹æ£€æµ‹
                                    </button>
                                </div>
                                <div class="text-xs text-slate-500" id="visionHint">éœ€è¦æ‘„åƒå¤´æƒé™ï¼Œæ£€æµ‹æ—¶ä¿æŒ60cmè·ç¦»</div>
                            </div>
                            <div class="glass rounded-xl p-4 border border-slate-100 w-full md:w-52">
                                <div class="text-sm text-slate-500 mb-2">ä¸Šä¼ OCTå›¾åƒ</div>
                                <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                                <button class="w-full border border-dashed border-slate-300 rounded-lg py-3 text-slate-600 text-sm hover:border-slate-400" onclick="document.getElementById('imageInput').click()">
                                    <i class="fa fa-upload mr-1"></i> é€‰æ‹©å›¾ç‰‡
                                </button>
                                <div class="text-xs text-slate-500 mt-2" id="fileNameDisplay">æœªé€‰æ‹©æ–‡ä»¶</div>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 border border-slate-100">
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-semibold">æ£€æµ‹å†å²ï¼ˆæœ€è¿‘ï¼‰</div>
                                <button class="text-xs text-blue-600 hover:underline" onclick="loadHealthData()">åˆ·æ–°</button>
                            </div>
                            <div class="space-y-2 text-sm" id="visionHistory">
                                <div class="text-slate-500">æš‚æ— æ•°æ®ï¼Œå®Œæˆä¸€æ¬¡æ£€æµ‹åæ˜¾ç¤º</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: AIåŒ»ç”Ÿ -->
                    <div id="tab-chat" class="p-0 tab-panel hidden">
                        <div class="h-[640px] flex flex-col">
                            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50" id="chatMessages">
                                <div class="text-center text-slate-400 text-sm mt-6">è¾“å…¥ç—‡çŠ¶ï¼Œæˆ–ä¸Šä¼ çœ¼éƒ¨å›¾ç‰‡ï¼Œè·å¾—è¯Šæ–­å»ºè®®</div>
                            </div>
                            <div class="border-t border-slate-200 p-4 space-y-2">
                                <div class="flex flex-wrap gap-2" id="actionsRow"></div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 relative">
                                        <textarea id="messageInput" rows="2" class="w-full border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="æè¿°æ‚¨çš„çœ¼éƒ¨ç—‡çŠ¶..." onkeydown="handleKeyDown(event)"></textarea>
                                    </div>
                                    <button id="sendBtn" class="gradient-blue text-white px-4 py-2 rounded-xl shadow hover:shadow-lg" onclick="sendMessage()">
                                        å‘é€
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2 text-xs text-blue-700">
                                    <span class="chip bg-blue-50 border border-blue-100" onclick="quickAsk('çœ¼ç›å¹²æ¶©è¯¥æ€ä¹ˆåŠï¼Ÿ')">çœ¼ç›å¹²æ¶©</span>
                                    <span class="chip bg-blue-50 border border-blue-100" onclick="quickAsk('çœ‹è¿œå¤„æ¨¡ç³Šï¼Œéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ')">è¿œå¤„æ¨¡ç³Š</span>
                                    <span class="chip bg-blue-50 border border-blue-100" onclick="quickAsk('æœ‰é£èšŠå’Œé—ªå…‰ï¼Œéœ€è¦å°±åŒ»å—ï¼Ÿ')">é£èšŠ/é—ªå…‰</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: ç–¾ç—…è¯Šæ–­ -->
                    <div id="tab-disease" class="p-4 md:p-6 space-y-4 tab-panel hidden">
                        <div class="glass rounded-xl p-4 border border-slate-100">
                            <div class="flex items-center gap-2">
                                <input id="diseaseInput" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥ç–¾ç—…ç±»å‹ï¼Œä¾‹å¦‚ï¼šè¿‘è§† / AMD / é’å…‰çœ¼">
                                <button class="gradient-green text-white px-4 py-2 rounded-lg shadow" onclick="queryDisease()">æŸ¥è¯¢</button>
                            </div>
                            <div class="mt-4 text-sm space-y-2" id="diseaseResult">
                                <div class="text-slate-500">æ”¯æŒæŸ¥è¯¢ï¼šè¿‘è§†ã€è¿œè§†ã€æ•£å…‰ã€AMDã€CNV ç­‰</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: ä¸ªäººä¸­å¿ƒ -->
                    <div id="tab-profile" class="p-4 md:p-6 space-y-4 tab-panel hidden">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="glass rounded-xl p-4 border border-slate-100">
                                <div class="text-sm text-slate-500 mb-2">å½“å‰è§†åŠ›</div>
                                <div class="text-2xl font-semibold" id="profileVision">--</div>
                                <div class="text-xs text-slate-500 mt-1">åŸºäºæœ€è¿‘ä¸€æ¬¡æ£€æµ‹</div>
                            </div>
                            <div class="glass rounded-xl p-4 border border-slate-100">
                                <div class="text-sm text-slate-500 mb-2">æœ€æ–°OCTç»“æœ</div>
                                <div class="text-lg font-semibold" id="profileOct">--</div>
                                <div class="text-xs text-slate-500 mt-1">ä¸Šä¼ çœ¼åº•å›¾åè‡ªåŠ¨æ›´æ–°</div>
                            </div>
                        </div>
                        <div class="glass rounded-xl p-4 border border-slate-100">
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-semibold">å·¥å…·çŠ¶æ€</div>
                                <button class="text-xs text-blue-600 hover:underline" onclick="checkToolStatus()">åˆ·æ–°</button>
                            </div>
                            <div class="text-sm space-y-1" id="toolStatusDetail"></div>
                        </div>
                        <div class="glass rounded-xl p-4 border border-slate-100">
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-semibold">è§†åŠ›è¶‹åŠ¿ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰</div>
                            </div>
                            <div class="h-48">
                                <canvas id="visionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå³æ—¶ä¿¡æ¯ -->
            <div class="space-y-4">
                <div class="glass card-shadow rounded-2xl p-4 border border-slate-100">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <div class="text-sm text-slate-500">é£é™©è¯„ä¼°</div>
                            <div class="text-lg font-semibold" id="riskBadge">--</div>
                        </div>
                        <div id="riskTag" class="text-xs px-3 py-1 rounded-full bg-slate-100 text-slate-600">æœªè¯„ä¼°</div>
                    </div>
                    <div class="text-sm text-slate-600" id="followupBox">ç­‰å¾…è¾“å…¥åæä¾›è¿½é—®å»ºè®®</div>
                </div>
                <div class="glass card-shadow rounded-2xl p-4 border border-slate-100">
                    <div class="text-sm text-slate-500 mb-2">æœ€æ–°æŠ¥å‘Š / ä¸‹è½½</div>
                    <div class="flex flex-wrap gap-2 text-xs" id="downloadChips">
                        <span class="text-slate-400">æ— å¯ç”¨æŠ¥å‘Š</span>
                    </div>
                </div>
                <div class="glass card-shadow rounded-2xl p-4 border border-slate-100">
                    <div class="text-sm text-slate-500 mb-2">å¿«é€Ÿæ“ä½œ</div>
                    <div class="flex flex-wrap gap-2">
                        <button class="chip bg-blue-50 border border-blue-100" onclick="switchTab('tab-vision')">å»æµ‹è§†åŠ›</button>
                        <button class="chip bg-green-50 border border-green-100" onclick="document.getElementById('imageInput').click()">ä¸Šä¼ OCT</button>
                        <button class="chip bg-purple-50 border border-purple-100" onclick="switchTab('tab-chat')">AIé—®è¯Š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000';
        let userId = localStorage.getItem('user_id') || null;
        let lastActions = [];
        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('tab-vision');
            checkToolStatus();
            loadHealthData();
            initChart();
        });

        function switchTab(id) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('tab-active'));
            document.querySelector(`[data-tab="${id}"]`)?.classList.add('tab-active');
        }

        async function checkToolStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/tool-status`);
                const data = await res.json();
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (data.llm_ready && data.oct_ready) {
                    statusDot.classList.remove('bg-amber-400','bg-red-400');
                    statusDot.classList.add('bg-emerald-500');
                    statusText.textContent = 'æœåŠ¡æ­£å¸¸';
                } else {
                    statusDot.classList.remove('bg-emerald-500');
                    statusDot.classList.add('bg-amber-400');
                    statusText.textContent = 'éƒ¨åˆ†æœåŠ¡ä¸å¯ç”¨';
                }
                updateToolStatusDisplay(data);
            } catch (e) {
                console.error(e);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            addChatBubble(text, true);
            input.value = '';
            setLoading(true);
            try {
                const resp = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, user_id: userId })
                });
                const data = await resp.json();
                if (data.user_id) {
                    userId = data.user_id; localStorage.setItem('user_id', userId);
                }
                handleResponseData(data);
            } catch (e) {
                addSystemInfo('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
            } finally {
                setLoading(false);
            }
        }

        async function handleImageUpload(e) {
            const file = e.target.files[0];
            document.getElementById('fileNameDisplay').textContent = file ? file.name : 'æœªé€‰æ‹©æ–‡ä»¶';
            if (!file) return;
            const formData = new FormData();
            formData.append('image', file);
            formData.append('user_id', userId || '');
            setLoading(true);
            try {
                const resp = await fetch(`${API_BASE}/chat`, { method: 'POST', body: formData });
                const data = await resp.json();
                if (data.user_id) { userId = data.user_id; localStorage.setItem('user_id', userId); }
                handleResponseData(data);
            } catch (e) {
                addSystemInfo('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                setLoading(false);
                e.target.value = '';
            }
        }

        async function startVisionTest() {
            setLoading(true);
            try {
                const resp = await fetch(`${API_BASE}/action/vision-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await resp.json();
                if (data.user_id) { userId = data.user_id; localStorage.setItem('user_id', userId); }
                handleResponseData(data);
                loadHealthData();
            } catch (e) {
                addSystemInfo('è§†åŠ›æ£€æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´');
            } finally {
                setLoading(false);
            }
        }

        async function loadHealthData() {
            try {
                const resp = await fetch(`${API_BASE}/api/profile/health-data`);
                const data = await resp.json();
                if (data.status === 'ok') {
                    const vision = data.current_vision;
                    const vt = data.vision_test || {};
                    document.getElementById('currentVision').textContent = vision ? vision.toFixed(2) : '--';
                    document.getElementById('visionSummary').textContent = vt.left || vt.right ? `å·¦ ${vt.left || '--'} / å³ ${vt.right || '--'}` : 'æš‚æ— è®°å½•';
                    document.getElementById('profileVision').textContent = vt.left || vt.right ? `å·¦ ${vt.left || '--'} / å³ ${vt.right || '--'}` : '--';
                    if (data.vision_test) updateVisionHistory([data.vision_test]);
                    if (data.oct_result) {
                        document.getElementById('octResult').textContent = data.oct_result;
                        document.getElementById('profileOct').textContent = data.oct_result;
                    }
                    updateChartSample(vision);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function queryDisease() {
            const val = document.getElementById('diseaseInput').value.trim();
            if (!val) return;
            try {
                const resp = await fetch(`${API_BASE}/api/diagnosis/disease?type=${encodeURIComponent(val)}`);
                const data = await resp.json();
                renderDisease(data);
            } catch (e) {
                renderDisease({ status: 'error', message: 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
            }
        }

        function renderDisease(data) {
            const box = document.getElementById('diseaseResult');
            if (data.status === 'error') {
                box.innerHTML = `<div class="text-red-500 text-sm">${data.message || 'æŸ¥è¯¢å¤±è´¥'}</div>`;
                return;
            }
            box.innerHTML = `
                <div class="font-semibold text-base">${data.name || 'æœªçŸ¥ç–¾ç—…'}</div>
                <div class="text-sm text-slate-600 mt-1">${data.description || 'æš‚æ— æè¿°'}</div>
                <div class="text-sm mt-2"><span class="font-semibold">ç—‡çŠ¶ï¼š</span>${(data.symptoms||[]).join('ï¼Œ') || 'æš‚æ— '}</div>
                <div class="text-sm mt-1"><span class="font-semibold">æˆå› ï¼š</span>${(data.causes||[]).join('ï¼Œ') || 'æš‚æ— '}</div>
                <div class="text-sm mt-1"><span class="font-semibold">æ²»ç–—ï¼š</span>${(data.treatment||[]).join('ï¼Œ') || 'æš‚æ— '}</div>
                <div class="text-sm mt-1"><span class="font-semibold">é¢„é˜²ï¼š</span>${(data.prevention||[]).join('ï¼Œ') || 'æš‚æ— '}</div>
            `;
        }

        function handleResponseData(data) {
            if (data.status !== 'ok') {
                addSystemInfo(data.message || 'å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                return;
            }
            const answer = data.answer || data.message || 'æ”¶åˆ°';
            addChatBubble(answer, false, data.data);
            updateRisk(data.data);
            if (data.data?.vision_test) {
                document.getElementById('visionSummary').textContent = `å·¦ ${data.data.vision_test.left || '--'} / å³ ${data.data.vision_test.right || '--'}`;
                updateVisionHistory([data.data.vision_test]);
            }
            if (data.data?.oct_result) {
                document.getElementById('octResult').textContent = data.data.oct_result;
                document.getElementById('profileOct').textContent = data.data.oct_result;
            }
            const actions = collectActions(data);
            renderActions(actions);
            renderDownloads(actions);
        }

        function collectActions(data) {
            const res = [];
            if (Array.isArray(data.actions)) res.push(...data.actions);
            if (data.data && Array.isArray(data.data.actions)) res.push(...data.data.actions);
            if (data.action && typeof data.action === 'string') res.push({ type: data.action });
            return res;
        }

        function renderActions(actions) {
            lastActions = actions || [];
            const row = document.getElementById('actionsRow');
            row.innerHTML = '';
            lastActions.forEach(act => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1 text-xs rounded-full border border-slate-200 bg-white hover:border-blue-400';
                btn.textContent = actionLabel(act);
                btn.onclick = () => handleAction(act);
                row.appendChild(btn);
            });
        }

        function renderDownloads(actions) {
            const box = document.getElementById('downloadChips');
            box.innerHTML = '';
            const downloads = actions.filter(a => a.type === 'download' && a.url);
            if (!downloads.length) {
                box.innerHTML = '<span class="text-slate-400 text-xs">æ— å¯ç”¨æŠ¥å‘Š</span>';
                return;
            }
            downloads.forEach(d => {
                const chip = document.createElement('button');
                chip.className = 'chip bg-emerald-50 border border-emerald-100 text-emerald-700';
                chip.textContent = d.text || 'ä¸‹è½½æŠ¥å‘Š';
                chip.onclick = () => window.open(d.url, '_blank');
                box.appendChild(chip);
            });
        }

        function actionLabel(a) {
            switch (a.type) {
                case 'vision_test': return 'è¿›è¡Œè§†åŠ›æ£€æµ‹';
                case 'upload_image': return 'ä¸Šä¼ OCTå›¾';
                case 'download': return a.text || 'ä¸‹è½½æŠ¥å‘Š';
                default: return a.text || 'æ“ä½œ';
            }
        }

        function handleAction(a) {
            if (!a) return;
            if (a.type === 'vision_test') switchTab('tab-vision'), startVisionTest();
            if (a.type === 'upload_image') document.getElementById('imageInput').click();
            if (a.type === 'download' && a.url) window.open(a.url, '_blank');
        }

        function addChatBubble(text, isUser = false, extra = {}) {
            const box = document.getElementById('chatMessages');
            const wrap = document.createElement('div');
            wrap.className = `flex ${isUser ? 'justify-end' : 'justify-start'} bubble`;
            const content = document.createElement('div');
            content.className = `max-w-[80%] rounded-2xl px-3 py-2 text-sm ${isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border border-slate-200 rounded-bl-none'}`;
            content.textContent = text;
            wrap.appendChild(content);
            box.appendChild(wrap);
            // followups
            if (!isUser && extra?.followups?.length) {
                const frow = document.createElement('div');
                frow.className = 'flex flex-wrap gap-2 mt-2';
                extra.followups.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = 'chip bg-blue-50 border border-blue-100 text-blue-700';
                    btn.textContent = f;
                    btn.onclick = () => { document.getElementById('messageInput').value = f; sendMessage(); };
                    frow.appendChild(btn);
                });
                box.appendChild(frow);
            }
            box.scrollTop = box.scrollHeight;
        }

        function addSystemInfo(msg) {
            const box = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'text-center text-xs text-slate-500';
            div.textContent = msg;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function setLoading(flag) {
            const btn = document.getElementById('sendBtn');
            if (flag) {
                btn.disabled = true;
                btn.textContent = 'å‘é€ä¸­...';
            } else {
                btn.disabled = false;
                btn.textContent = 'å‘é€';
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        function quickAsk(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        function updateRisk(data) {
            if (!data) return;
            const risk = data.risk_level || data.risk;
            const tag = document.getElementById('riskTag');
            const badge = document.getElementById('riskBadge');
            const follow = document.getElementById('followupBox');
            const map = { high: ['é«˜é£é™©','bg-red-100 text-red-700'], medium: ['ä¸­é£é™©','bg-amber-100 text-amber-700'], low: ['ä½é£é™©','bg-emerald-100 text-emerald-700'] };
            if (risk && map[risk]) {
                badge.textContent = map[risk][0];
                tag.className = `text-xs px-3 py-1 rounded-full ${map[risk][1]}`;
                tag.textContent = map[risk][0];
            }
            if (data.followups?.length) {
                follow.innerHTML = '<span class="font-semibold">è¿½é—®å»ºè®®ï¼š</span>' + data.followups.join('ï¼›');
            }
        }

        function updateToolStatusDisplay(status) {
            if (!status) return;
            const detail = document.getElementById('toolStatusDetail');
            detail.innerHTML = `
                <div>LLMï¼š${status.llm_ready ? 'å¯ç”¨' : 'æœªå°±ç»ª'} ${status.llm_error ? '('+status.llm_error+')' : ''}</div>
                <div>OCTï¼š${status.oct_ready ? 'å¯ç”¨' : 'æœªå°±ç»ª'} ${status.oct_error ? '('+status.oct_error+')' : ''}</div>
            `;
        }

        function updateVisionHistory(list) {
            const box = document.getElementById('visionHistory');
            box.innerHTML = '';
            list.slice(0,3).forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg border border-slate-200 bg-white flex justify-between text-sm';
                div.innerHTML = `<span>${new Date().toLocaleDateString()}</span><span>å·¦ ${item.left || '--'} / å³ ${item.right || '--'}</span>`;
                box.appendChild(div);
            });
        }

        function initChart() {
            const ctx = document.getElementById('visionChart');
            if (!ctx) return;
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ'],
                    datasets: [{
                        label: 'è§†åŠ›(ç¤ºä¾‹)',
                        data: [1.0,0.9,0.9,0.85,0.8,0.78],
                        borderColor: '#2563eb',
                        tension: 0.35,
                        fill: false
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: 0.5, max: 1.2 } } }
            });
        }

        function updateChartSample(latest) {
            if (!chartInstance || latest === undefined || latest === null) return;
            const d = chartInstance.data.datasets[0].data;
            d[d.length-1] = Number(latest.toFixed(2));
            chartInstance.update();
        }
    </script>
</body>
</html>

